---
import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content, headings } = await post.render();
const base = import.meta.env.BASE_URL;
const faq = post.data.faq;
const h2 = headings.filter(h => h.depth === 2);

// Чередуем фото автора по первому символу slug
const authorPhoto = post.slug.charCodeAt(0) % 2 === 0
  ? `${base}images/olga-karpova-80.webp`
  : `${base}images/olga-karpova-2-80.webp`;
---

<Layout title={post.data.title} description={post.data.description} image={post.data.image} articleSchema publishDate={post.data.pubDate.toISOString()}>
    <!-- Хлебные крошки -->
    <nav class="text-sm text-gray-500 mb-6 flex items-center flex-wrap gap-1">
        <a href={base} class="hover:text-[rgb(var(--accent))] transition-colors">Главная</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        <a href={`${base}blog`} class="hover:text-[rgb(var(--accent))] transition-colors">Блог</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        <span class="text-gray-700 truncate">{post.data.title}</span>
    </nav>

	<article class="prose prose-lg prose-indigo mx-auto">
        <div class="text-center mb-12">
            <span class="text-base text-[rgb(var(--accent))] font-semibold tracking-wide uppercase">{post.data.category}</span>
            <h1 class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                {post.data.title}
            </h1>
            <div class="mt-4 flex justify-center items-center text-gray-500 text-sm">
                <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
                 <span class="mx-2">&middot;</span>
                 <span>Карпова Ольга</span>
            </div>
        </div>

        {post.data.image && (
            <div class="relative w-full h-96 mb-8 rounded-xl overflow-hidden shadow-lg">
                <img src={`${import.meta.env.BASE_URL}${post.data.image?.replace(/^\//, '')}`} alt={post.data.title} class="w-full h-full object-cover" loading="lazy" decoding="async" />
            </div>
        )}

        {/* Содержание — только если есть 2+ раздела H2 */}
        {h2.length >= 2 && (
            <details class="not-prose mb-8 rounded-xl border border-gray-200 bg-gray-50 open:bg-white" open>
                <summary class="flex cursor-pointer items-center justify-between px-5 py-4 font-semibold text-gray-900 hover:bg-gray-50 rounded-xl list-none [&::-webkit-details-marker]:hidden">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-[rgb(var(--accent))]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10"/></svg>
                        Содержание
                    </span>
                    <svg class="w-5 h-5 text-gray-400 transition-transform [[open]_&]:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </summary>
                <ol class="px-5 pb-4 pt-1 space-y-1 text-sm text-gray-700">
                    {h2.map((heading, i) => (
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5 text-xs font-bold text-[rgb(var(--accent))] w-5 flex-shrink-0">{i + 1}.</span>
                            <a href={`#${heading.slug}`} class="hover:text-[rgb(var(--accent))] hover:underline transition-colors leading-snug">{heading.text}</a>
                        </li>
                    ))}
                </ol>
            </details>
        )}

		<Content />

        {/* FAQ блок — если есть faq в frontmatter */}
        {faq && faq.length > 0 && (
            <section class="mt-12 not-prose">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Частые вопросы</h2>
                <div class="space-y-4">
                    {faq.map((item) => (
                        <details class="group bg-white border border-gray-200 rounded-lg">
                            <summary class="flex items-center justify-between cursor-pointer px-6 py-4 text-lg font-medium text-gray-900 hover:bg-gray-50 rounded-lg">
                                {item.question}
                                <svg class="w-5 h-5 text-gray-500 transition-transform group-open:rotate-180 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="px-6 pb-4 text-gray-600 leading-relaxed">
                                {item.answer}
                            </div>
                        </details>
                    ))}
                </div>
            </section>
        )}

        <!-- Блок автора -->
        <div class="mt-12 not-prose border-t pt-8">
            <div class="flex items-center gap-4">
                <img
                    src={authorPhoto}
                    alt="Карпова Ольга — нутрициолог"
                    width="64"
                    height="64"
                    class="w-16 h-16 rounded-full object-cover shadow flex-shrink-0"
                    loading="lazy"
                />
                <div>
                    <p class="font-bold text-gray-900 text-lg leading-tight">Карпова Ольга</p>
                    <p class="text-sm text-[rgb(var(--accent))] font-semibold">Нутрициолог-практик · 12 лет опыта</p>
                    <p class="text-sm text-gray-500 mt-1">Помогаю наладить питание и сформировать здоровые привычки без жёстких диет.</p>
                    <div class="flex gap-3 mt-2">
                        <a href="https://t.me/olgakarpovaking" target="_blank" rel="noopener noreferrer" class="text-sky-500 hover:text-sky-600 text-sm font-medium transition-colors">Telegram</a>
                        <span class="text-gray-300">·</span>
                        <a href="https://vk.ru/id573975171" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">ВКонтакте</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- CTA-блок — автоматически в конце каждой статьи -->
        <div class="mt-8 p-8 bg-gray-50 rounded-2xl text-center not-prose">
            <h3 class="text-xl font-bold text-gray-900 mb-3">Хотите разобраться в питании и здоровье?</h3>
            <p class="text-gray-600 mb-6">Приглашаю на бесплатный 3-дневный марафон «Нормализация веса за 12 недель» — разберём ваши вопросы с нутрициологом.</p>
            <a
                href={`https://lk.getfit.su/link/67srjzjg1?utm_source=partner&utm_medium=seo&utm_campaign=${post.slug}&utm_content=cta_end`}
                target="_blank"
                rel="noopener noreferrer nofollow"
                class="inline-block px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
            >
                ЗАПИСАТЬСЯ НА МАРАФОН
            </a>
            <p class="text-xs text-gray-400 mt-4">Реклама. ООО "ЭДПРО", ИНН 7704394080, erid: 67srjzjg1</p>
        </div>
	</article>

    {/* FAQPage JSON-LD schema */}
    {faq && faq.length > 0 && (
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "FAQPage",
            "mainEntity": faq.map((item) => ({
                "@type": "Question",
                "name": item.question,
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": item.answer
                }
            }))
        })} />
    )}

    <div class="mt-16 border-t pt-8 text-center">
        <a href={`${import.meta.env.BASE_URL}blog`} class="text-base font-medium text-[rgb(var(--accent))] hover:text-indigo-500">
            &larr; Вернуться к списку статей
        </a>
    </div>
</Layout>
