---
import { type CollectionEntry, getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();
const base = import.meta.env.BASE_URL;
const faq = post.data.faq;
---

<Layout title={post.data.title} description={post.data.description} image={post.data.image} articleSchema publishDate={post.data.pubDate.toISOString()}>
    <!-- Хлебные крошки -->
    <nav class="text-sm text-gray-500 mb-6 flex items-center flex-wrap gap-1">
        <a href={base} class="hover:text-[rgb(var(--accent))] transition-colors">Главная</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        <a href={`${base}blog`} class="hover:text-[rgb(var(--accent))] transition-colors">Блог</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        <span class="text-gray-700 truncate">{post.data.title}</span>
    </nav>

	<article class="prose prose-lg prose-indigo mx-auto">
        <div class="text-center mb-12">
            <span class="text-base text-[rgb(var(--accent))] font-semibold tracking-wide uppercase">{post.data.category}</span>
            <h1 class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                {post.data.title}
            </h1>
            <div class="mt-4 flex justify-center items-center text-gray-500 text-sm">
                <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
                 <span class="mx-2">&middot;</span>
                 <span>Карпова Ольга</span>
            </div>
        </div>

        {post.data.image && (
            <div class="relative w-full h-96 mb-8 rounded-xl overflow-hidden shadow-lg">
                <img src={`${import.meta.env.BASE_URL}${post.data.image?.replace(/^\//, '')}`} alt={post.data.title} class="w-full h-full object-cover" loading="lazy" decoding="async" />
            </div>
        )}

		<Content />

        {/* FAQ блок — если есть faq в frontmatter */}
        {faq && faq.length > 0 && (
            <section class="mt-12 not-prose">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Частые вопросы</h2>
                <div class="space-y-4">
                    {faq.map((item) => (
                        <details class="group bg-white border border-gray-200 rounded-lg">
                            <summary class="flex items-center justify-between cursor-pointer px-6 py-4 text-lg font-medium text-gray-900 hover:bg-gray-50 rounded-lg">
                                {item.question}
                                <svg class="w-5 h-5 text-gray-500 transition-transform group-open:rotate-180 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="px-6 pb-4 text-gray-600 leading-relaxed">
                                {item.answer}
                            </div>
                        </details>
                    ))}
                </div>
            </section>
        )}

        <!-- CTA-блок — автоматически в конце каждой статьи -->
        <div class="mt-12 p-8 bg-gray-50 rounded-2xl text-center not-prose">
            <h3 class="text-xl font-bold text-gray-900 mb-3">Хотите разобраться в питании и здоровье?</h3>
            <p class="text-gray-600 mb-6">Приглашаю на бесплатный 3-дневный марафон «Нормализация веса за 12 недель» — разберём ваши вопросы с нутрициологом.</p>
            <a
                href={`https://lk.getfit.su/link/67srjzjg1?utm_source=partner&utm_medium=seo&utm_campaign=${post.slug}&utm_content=cta_end`}
                target="_blank"
                rel="noopener noreferrer nofollow"
                class="inline-block px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
            >
                ЗАПИСАТЬСЯ НА МАРАФОН
            </a>
            <p class="text-xs text-gray-400 mt-4">Реклама. ООО "ЭДПРО", ИНН 7704394080, erid: 2VtzqXXXXXXXXXXX</p>
        </div>
	</article>

    {/* FAQPage JSON-LD schema */}
    {faq && faq.length > 0 && (
        <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "FAQPage",
            "mainEntity": faq.map((item) => ({
                "@type": "Question",
                "name": item.question,
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": item.answer
                }
            }))
        })} />
    )}

    <div class="mt-16 border-t pt-8 text-center">
        <a href={`${import.meta.env.BASE_URL}blog`} class="text-base font-medium text-[rgb(var(--accent))] hover:text-indigo-500">
            &larr; Вернуться к списку статей
        </a>
    </div>
</Layout>
